var McaBrowserDetect={init:function(){this.browser=this.searchString(this.dataBrowser)||"Other",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"Unknown"},searchString:function(a){for(var b=0;a.length>b;b++){var c=a[b].string;if(this.versionSearchString=a[b].subString,-1!=c.indexOf(a[b].subString))return a[b].identity}},searchVersion:function(a){var b=a.indexOf(this.versionSearchString);if(-1!=b)return parseFloat(a.substring(b+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.userAgent,subString:"Safari",identity:"Safari"},{string:navigator.userAgent,subString:"Opera",identity:"Opera"}]};McaBrowserDetect.init(),jQuery(document).ready(function(a){var b={primaryStyles:["fontFamily","fontSize","fontWeight","fontVariant","fontStyle","paddingLeft","paddingTop","paddingBottom","paddingRight","marginLeft","marginTop","marginBottom","marginRight","borderLeftColor","borderTopColor","borderBottomColor","borderRightColor","borderLeftStyle","borderTopStyle","borderBottomStyle","borderRightStyle","borderLeftWidth","borderTopWidth","borderBottomWidth","borderRightWidth","line-height","outline"],specificStyle:{"word-wrap":"break-word","overflow-x":"hidden","overflow-y":"auto"},simulator:a('<div id="textarea_simulator"/>').css({position:"absolute",top:0,left:0,visibility:"hidden"}).appendTo(document.body),toHtml:function(a){return a.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").split(" ").join('<span style="white-space:prev-wrap">&nbsp;</span>')},getCaretPosition:function(){var c=b,d=this,e=d[0],f=d.offset();if("MSIE"==McaBrowserDetect.browser&&9>=McaBrowserDetect.version){e.focus();var g=document.selection.createRange();return a("#hskeywords").val(e.scrollTop),{left:g.boundingLeft-f.left,top:parseInt(g.boundingTop)-f.top+e.scrollTop+document.documentElement.scrollTop+parseInt(d.getComputedStyle("fontSize"))}}c.simulator.empty(),a.each(c.primaryStyles,function(a,b){d.cloneStyle(c.simulator,b)}),c.simulator.css(a.extend({width:d.width(),height:d.height()},c.specificStyle));var h=d.val()||d.text(),i=d.getCursorPosition(),j=h.substring(0,i),k=h.substring(i),l=a('<span class="before"/>').html(c.toHtml(j)),m=a('<span class="focus"/>'),n=a('<span class="after"/>').html(c.toHtml(k));c.simulator.append(l).append(m).append(n);var o=m.offset(),p=c.simulator.offset();return{top:o.top-p.top-e.scrollTop+("Firefox"==McaBrowserDetect.browser?0:parseInt(d.getComputedStyle("fontSize"))),left:m[0].offsetLeft-c.simulator[0].offsetLeft-e.scrollLeft}}};a.fn.extend({setCursorPosition:function(b){return 0==this.length?this:a(this).setSelection(b,b)},setSelection:function(a,b){if(0==this.length)return this;if(input=this[0],input.createTextRange){var c=input.createTextRange();c.collapse(!0),c.moveEnd("character",b),c.moveStart("character",a),c.select()}else if(input.setSelectionRange)input.focus(),input.setSelectionRange(a,b);else{var d=this.get(0),c=document.createRange();c.collapse(!0),c.setStart(d.childNodes[0],a),c.setEnd(d.childNodes[0],b);var e=window.getSelection();e.removeAllRanges(),e.addRange(c)}return this},getComputedStyle:function(a){if(0!=this.length){var b=this[0],c=this.css(a);return c=c||("MSIE"==McaBrowserDetect.browser?b.currentStyle[a]:document.defaultView.getComputedStyle(b,null)[a])}},cloneStyle:function(b,c){var d=this.getComputedStyle(c);d&&a(b).css(c,d)},cloneAllStyle:function(a){var c=this[0];for(var d in c.style){var e=c.style[d];"string"==typeof e||"number"==typeof e?this.cloneStyle(a,d):0/0}},getCursorPosition:function(){var a=input=this[0],b=input.value||input.innerText;this.data("lastCursorPosition")||this.data("lastCursorPosition",0);var c=this.data("lastCursorPosition");if(document.selection){input.focus();var d=document.selection.createRange(),e=document.selection.createRange().text.length;d.moveStart("character",-b.length),c=d.text.length-e}else{if(input.selectionStart||"0"==input.selectionStart)return input.selectionStart;if(window.getSelection!==void 0&&window.getSelection().rangeCount>0)try{var f=window.getSelection(),g=f.getRangeAt(0),h=g.cloneRange();h.selectNodeContents(a),h.setEnd(g.endContainer,g.endOffset),c=(""+h).length}catch(i){c=this.data("lastCursorPosition")}else if(document.selection!==void 0&&"Control"!=document.selection.type){var j=document.selection.createRange(),k=document.body.createTextRange();k.moveToElementText(a),k.setEndPoint("EndToEnd",j),c=k.text.length}}return this.data("lastCursorPosition",c),c},getCaretPosition:b.getCaretPosition})}),function(a,b,c){function h(b,c){this.element=b,this.$element=a(b),this.$itemList=a(h.MENU_TEMPLATE),this.options=a.extend({},g,c),this.reset(),this._defaults=g,this._name=e,this.expression=RegExp("(?:^|\\b|\\s)"+this.options.token+"([\\w.]*)$"),this.cleanupHandle=null,this.init()}var d=function(a,b){a.text(b.val)},e="sew",g=(b.document,{token:"@",elementFactory:d,values:[],unique:!1,repeat:!0});h.MENU_TEMPLATE="<div class='-sew-list-container' style='display: none; position: absolute;'><ul class='-sew-list'></ul></div>",h.ITEM_TEMPLATE='<li class="-sew-list-item"></li>',h.KEYS=[40,38,13,27,9],h.prototype.init=function(){1>this.options.values.length||this.$element.bind("keyup",a.proxy(this.onKeyUp,this)).bind("keydown",a.proxy(this.onKeyDown,this)).bind("focus",a.proxy(this.renderElements,this,this.options.values)).bind("blur",a.proxy(this.remove,this))},h.prototype.reset=function(){this.options.unique&&(this.options.values=h.getUniqueElements(this.options.values)),this.index=0,this.matched=!1,this.dontFilter=!1,this.lastFilter=c,this.filtered=this.options.values.slice(0)},h.prototype.next=function(){this.index=(this.index+1)%this.filtered.length,this.hightlightItem()},h.prototype.prev=function(){this.index=(this.index+this.filtered.length-1)%this.filtered.length,this.hightlightItem()},h.prototype.select=function(){this.replace(this.filtered[this.index].val),this.hideList()},h.prototype.remove=function(){this.$itemList.fadeOut("slow"),this.cleanupHandle=b.setTimeout(a.proxy(function(){this.$itemList.remove()},this),1e3)},h.prototype.replace=function(a){var b=this.$element.getCursorPosition(),c=1===b?"":" ",d=this.getText(),e=d.substring(0,b);e=e.replace(this.expression,c+this.options.token+a);var f=d.substring(b,d.length),g=f.match(/^\s/)?"":" ",h=e+g+f;this.setText(h),this.$element.setCursorPosition(e.length+1)},h.prototype.hightlightItem=function(){this.$itemList.find(".-sew-list-item").removeClass("selected");var a=this.$itemList.find(".-sew-list-item").parent(),b=this.filtered[this.index].element.addClass("selected"),c=b.position().top;a.scrollTop(a.scrollTop()+c)},h.prototype.renderElements=function(b){a("body").append(this.$itemList);var c=this.$itemList.find("ul").empty();b.forEach(a.proxy(function(b,d){var e=a(h.ITEM_TEMPLATE);this.options.elementFactory(e,b),b.element=e.appendTo(c).bind("click",a.proxy(this.onItemClick,this,b)).bind("mouseover",a.proxy(this.onItemHover,this,d))},this)),this.index=0,this.hightlightItem()},h.prototype.displayList=function(){if(this.filtered.length){this.$itemList.show();var a=this.$element,b=this.$element.offset(),c=a.getCaretPosition();this.$itemList.css({left:b.left+c.left,top:b.top+c.top})}},h.prototype.hideList=function(){this.$itemList.hide(),this.reset()},h.prototype.filterList=function(b){if(b!=this.lastFilter){this.lastFilter=b,this.$itemList.find(".-sew-list-item").remove();var c=this.options.values,d=this.filtered=c.filter(a.proxy(function(a){var c=RegExp("\\W*"+this.options.token+a.val+"(\\W|$)");return!this.options.repeat&&this.getText().match(c)?!1:""===b||a.val.toLowerCase().indexOf(b.toLowerCase())>=0||(a.meta||"").toLowerCase().indexOf(b.toLowerCase())>=0},this));d.length?(this.renderElements(d),this.$itemList.show()):this.hideList()}},h.getUniqueElements=function(a){var b=[];return a.forEach(function(a){var c=b.map(function(a){return a.val}).indexOf(a.val)>=0;c||b.push(a)}),b},h.prototype.getText=function(){return this.$element.val()||this.$element.text()},h.prototype.setText=function(b){this.$element.prop("tagName").match(/input|textarea/i)?this.$element.val(b):(b=a("<span>").text(b).html().replace(/\s/g,"&nbsp"),this.$element.html(b))},h.prototype.onKeyUp=function(){var b=this.$element.getCursorPosition(),d=this.getText().substring(0,b),e=d.match(this.expression);return!e&&this.matched?(this.matched=!1,this.dontFilter=!1,this.hideList(),c):(e&&!this.matched&&(this.displayList(),this.lastFilter="\n",this.matched=!0),e&&!this.dontFilter&&this.filterList(e[1]),c)},h.prototype.onKeyDown=function(a){var b=this.$itemList.is(":visible");if(b&&!(0>h.KEYS.indexOf(a.keyCode))){switch(a.keyCode){case 9:case 13:this.select();break;case 40:this.next();break;case 38:this.prev();break;case 27:this.$itemList.hide(),this.dontFilter=!0}a.preventDefault()}},h.prototype.onItemClick=function(a){this.cleanupHandle&&b.clearTimeout(this.cleanupHandle),this.replace(a.val),this.hideList()},h.prototype.onItemHover=function(a){this.index=a,this.hightlightItem()},a.fn[e]=function(b){return this.each(function(){a.data(this,"plugin_"+e)||a.data(this,"plugin_"+e,new h(this,b))})}}(jQuery,window);